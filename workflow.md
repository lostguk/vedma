# Инструкция по реализации новых фич (workflow)

## Общие принципы

-   Следуем стандартам и best practices Laravel 11 и PHP 8.3+ ([см. ./.cursor/rules/laravel.mdc](./.cursor/rules/laravel.mdc))
-   Все этапы оформляем на русском языке
-   Каждый этап тестируем и документируем
-   Используем Docker для всех команд
-   Проверяем существование сущностей перед созданием новых файлов/кода

---

## Этапы реализации фичи (чек-лист)

### 1. Миграции, сиды и фабрики

-   [ ] Проверить существование миграций, сидов, фабрик
-   [ ] Создать/доработать миграции, сиды, фабрики
-   [ ] Заполнить миграции, сиды и фабрики. Если у нас есть связи, мы должны заполнить их правильно с уже существующими в базе записями. Для того чтобы у нас не было конфликтов, ошибок и прочих проблем.
-   [ ] Выполнить `./dev.sh reset-db`

**Пример команды:**

```bash
docker-compose -f docker-compose.local.yml exec php php artisan make:migration create_tags_table
```

```bash
./dev.sh reset-db
```

---

### 2. Модель

-   [ ] Добавляем модель или модели с помощью консоли
-   [ ] Описать модель максимально полно (final, строгая типизация, отношения, касты, fillable, hidden и т.д.) со всеми необходимыми полями, скоупами, связями..
-   [ ] Проверить соответствие бизнес-логике и архитектуре

**Пример команды:**

```bash
docker-compose -f docker-compose.local.yml exec php php artisan make:model Tag
```

**Пример:**

```php
final class Tag extends Model
{
    protected $fillable = ['name'];
    // ...
}
```

---

### 3. Управление через админку (Filament)

-   [ ] Проверить, реализовано ли управление сущностью в Filament
-   [ ] Создать новый ресурс/страницу или доработать существующий
-   [ ] Проверить полноту, добавить недостающие поля/функции
-   [ ] Проверить права доступа
-   [ ] Сгруппировать по логическим секциям все поля в форме как например в Заказах
-   [ ] Очищаем кеш Filament командой через докер
-   [ ] Все должно быть на русском языке

**Пример команды:**

```bash
docker-compose -f docker-compose.local.yml exec php php artisan make:filament-resource Tag
```

```bash
./dev.sh filament-cache
```

---

### 4. Routes и базовый Controllers

-   [ ] Создать роут с именем (name). Роуты лежат ./routes/api.php, но так же они разделяются по группам и по разным файлам если это необходимо и роутов много.
-   [ ] Проверить группировку роутов по сущностям
-   [ ] Создать базовый контроллер (final, только для чтения), $this->successResponse(...)
-   [ ] Использовать ApiController как базовый

**Пример:**

```php
Route::name('tags.')->group(function () {
    Route::get('/tags', [TagController::class, 'index'])->name('index');
});
```

```php
public function show(int $id): JsonResponse
{
    $page = $this->service->getById($id);

    return $this->successResponse(new PageResource($page));
}
```

---

### 5. Валидация

-   [ ] Создать Form Request в `app/Http/Requests/Api/V1` (если требуется)
-   [ ] Описать все правила валидации, авторизацию
-   [ ] Использовать кастомные сообщения при необходимости

**Пример команды:**

```bash
docker-compose -f docker-compose.local.yml exec php php artisan make:request Api/V1/TagStoreRequest
```

---

### 6. Repositories, API Resources и Services

-   [ ] Создать или доработать существующий репозиторий и сервис (final, только для чтения)
-   [ ] Описать интерфейсы и базовые классы при необходимости
-   [ ] Реализовать пагинацию для коллекций данных
-   [ ] Добавить сортировку и фильтрацию при необходимости
-   [ ] Описать Resource

**Пример команды:**

```bash
docker-compose -f docker-compose.local.yml exec php php artisan make:resource TagResource
```

**Пример репозитория:**

```php
final readonly class TagRepository
{
    public function __construct(
        private Tag $model,
    ) {
    }

    public function findById(int $id): ?Tag
    {
        return $this->model->find($id);
    }
}
```

---

### 7. Интеграция в Controllers

-   [ ] Внедрить сервис и репозиторий в контроллер через методы или сервис-контейнер
-   [ ] Интегрируем ранее описанные Resources в Controllers
-   [ ] Проверить работоспособность через тесты и ручное тестирование

---

### 8. Документация (Scribe)

-   [ ] Описать новую фичу в документации. Описываем с помощью правил Scribe
-   [ ] Добавляем описание нашего route в существующий подходящий Controller или Request
-   [ ] Обязательно добавляем наш описанный роут в группу или подгруппу в логически правильную группу/подгруппу
-   [ ] Сгенерировать новую документацию через knuckleswtf/scribe, каждый раз после любых изменений
-   [ ] Проверить, что все endpoints и параметры описаны верно

**Пример команды:**

```bash
./dev.sh docs
```

---

### 9. Тесты

-   [ ] Добавить feature-тесты для новой фичи
-   [ ] Проверить покрытие тестами
-   [ ] Все тесты должны проходить
-   [ ] Если тесты не прошли — исправить ошибки и повторить запуск

**Пример команды:**

```bash
docker-compose -f docker-compose.local.yml exec php php artisan make:test TagControllerTest
./dev.sh test
```

**Пример теста:**

```php
public function test_can_get_tags(): void
{
    $tag = Tag::factory()->create();

    $this->getJson(route('api.tags.index'))
        ->assertOk()
        ->assertJsonStructure([
            'data' => [
                '*' => ['id', 'name']
            ]
        ]);
}
```

### 10. Фича документация в ./docs/features

-   [ ] Добавить файл с соответствующим названием
-   [ ] Описать документацию в соответствии с уже созданными примерами
-   [ ] Провести code review перед созданием MR

**Пример структуры документации:**

```markdown
# Теги

## Описание
Система тегов позволяет категоризировать товары магазина по различным параметрам.

## API Endpoints
- `GET /api/tags` - получение списка тегов
- `GET /api/tags/{id}` - получение информации о конкретном теге
- `POST /api/tags` - создание нового тега
- `PUT /api/tags/{id}` - обновление тега
- `DELETE /api/tags/{id}` - удаление тега

## Модель данных
- `id` - уникальный идентификатор
- `name` - название тега
- `created_at` - дата создания
- `updated_at` - дата обновления

## Примеры использования
[примеры кода или скриншоты интерфейса]
```

---

## Автоматизация и CI/CD

-   Рекомендуется использовать Makefile или bash-скрипты для типовых команд (например, make migrate-fresh-seed, make test)
-   Все тесты и линтинг должны проходить в CI/CD перед мерджем изменений

---

## Шаблон для описания новой фичи

**Название фичи:**
**Цель:**
**Сущности и поля:**
**Права доступа:**
**Сценарии использования:**
**Требуемые тесты:**
**Документация:**

---

## FAQ и типовые ошибки

-   Ошибка миграции: проверьте порядок миграций и зависимости
-   Проблемы с сидерами: убедитесь, что сиды используют актуальные модели и фабрики
-   Ошибки прав в Filament: проверьте policies и middleware
-   Не отображается новая сущность в админке: проверьте регистрацию ресурса в Filament
-   Если pre-commit не срабатывает — проверьте права на .githooks/pre-commit и настройку core.hooksPath.
-   Pre-commit hook запускает Pint (./dev.sh lint) перед каждым коммитом. Если Pint находит ошибки форматирования, коммит отменяется.
-   Если Scribe выдаёт предупреждения или ошибки — проверьте аннотации, примеры и правила валидации. Часто помогает добавить или скорректировать bodyParameters() или примеры в аннотациях.

---

## Пример полного цикла (на примере сущности Tag)

1. Создать миграцию, сид, фабрику для Tag
2. Описать модель Tag
3. Добавить TagResource в Filament
4. Создать роуты и базовый контроллер TagController
5. Описать TagStoreRequest для валидации
6. Реализовать TagRepository, API Resources и TagService
7. Интегрировать сервис, ресурсы и репозиторий в TagController
8. Описать эндпоинты в Scribe
9. Добавить feature-тесты для Tag
10. Заполнить фича документацию в docs/features

---

## Обратная связь и доработки

-   Все предложения по улучшению workflow.md добавляйте в этот раздел или обсуждайте в команде

---

## Примечания

-   На каждом этапе использовать best practices Laravel и PHP
-   Все изменения согласовывать с архитектурой проекта
-   После каждого этапа проводить ревью и тестирование

## Автоматизация и типовые команды

-   Для всех основных задач используйте скрипт `./dev.sh`:
    -   `./dev.sh reset-db` — полный ресет базы и сиды
    -   `./dev.sh test` — запуск тестов
    -   `./dev.sh docs` — генерация документации
    -   `./dev.sh filament-cache` — очистка кэша Filament
    -   `./dev.sh lint` — автоформатирование Pint
    -   `./dev.sh ide-helper` — генерация ide-helper

## Pre-commit hook

-   В проекте настроен pre-commit hook для Pint.
-   Для активации:
    ```bash
    chmod +x .githooks/pre-commit
    git config core.hooksPath .githooks
    ```
-   Если pre-commit не срабатывает — проверьте права на .githooks/pre-commit и настройку core.hooksPath.
-   Pre-commit hook запускает Pint (./dev.sh lint) перед каждым коммитом. Если Pint находит ошибки форматирования, коммит отменяется.

## Рекомендации по тестам и документации

-   Для тестов и примеров в документации используйте уникальные email/значения, чтобы избежать ошибок уникальности.
-   Пример: для регистрации используйте `test+<timestamp>@example.com`.

## Обновление документации

-   После изменений в API, моделях или валидации обязательно обновляйте документацию командой `./dev.sh docs`.

## Проверка форматирования перед коммитом

-   Перед коммитом убедитесь, что Pint не выдаёт ошибок:
    ```bash
    ./dev.sh lint
    ```
