# Инструкция по реализации новых фич (workflow)

## Общие принципы

-   Следуем стандартам и best practices Laravel 11 и PHP 8.3+ ([см. ./.cursor/rules/laravel.mdc](./.cursor/rules/laravel.mdc))
-   Все этапы оформляем на русском языке
-   Каждый этап тестируем и документируем
-   Используем Docker для всех команд
-   Проверяем существование сущностей перед созданием новых файлов/кода

---

## Этапы реализации фичи (чек-лист)

### 1. Миграции, сиды и фабрики

-   [ ] Проверить существование миграций, сидов, фабрик
-   [ ] Создать/доработать миграции, сиды, фабрики
-   [ ] Заполнить миграции, сиды и фабрики
-   [ ] Выполнить `docker-compose -f docker-compose.local.yml exec php php artisan migrate:fresh --seed`

**Пример команды:**

```bash
docker-compose -f docker-compose.local.yml exec php php artisan make:migration create_tags_table
```

```bash
docker-compose -f docker-compose.local.yml exec php php artisan migrate:fresh --seed
```

---

### 2. Модель

-   [ ] Добавляем модель или модели с помощью консоли
-   [ ] Описать модель максимально полно (final, строгая типизация, отношения, касты, fillable, hidden и т.д.) со всеми необходимыми полями, скоупами, связями..
-   [ ] Проверить соответствие бизнес-логике и архитектуре

**Пример:**

```php
final class Tag extends Model
{
    protected $fillable = ['name'];
    // ...
}
```

---

### 3. Управление через админку (Filament)

-   [ ] Проверить, реализовано ли управление сущностью в Filament
-   [ ] Создать новый ресурс/страницу или доработать существующий
-   [ ] Проверить полноту, добавить недостающие поля/функции
-   [ ] Проверить права доступа
-   [ ] Очищаем кеш Filament командой через докер
-   [ ] Все должно быть на русском языке

**Пример команды:**

```bash
docker-compose -f docker-compose.local.yml exec php php artisan make:filament-resource Tag
```

```bash
docker-compose -f docker-compose.local.yml exec php php artisan filament:clear-cache
```

---

### 4. Роут и базовый контроллер

-   [ ] Создать роут с именем (name). Роуты лежат ./routes/api.php, но так же они разделяются по группам и по разным файлам если это необходимо и роутов много.
-   [ ] Проверить группировку роутов по сущностям
-   [ ] Создать базовый контроллер (final, только для чтения), $this->successResponse(...)
-   [ ] Использовать ApiController как базовый

**Пример:**

```php
Route::name('tags.')->group(function () {
    Route::get('/tags', [TagController::class, 'index'])->name('index');
});
```

```php
public function show(int $id): JsonResponse
{
    $page = $this->service->getById($id);

    return $this->successResponse(new PageResource($page));
}
```

---

### 5. Валидация

-   [ ] Создать Form Request в `app/Http/Requests/Api/V1` (если требуется)
-   [ ] Описать все правила валидации, авторизацию
-   [ ] Использовать кастомные сообщения при необходимости

**Пример команды:**

```bash
docker-compose -f docker-compose.local.yml exec php php artisan make:request Api/V1/TagStoreRequest
```

---

### 6. Репозиторий и сервис

-   [ ] Создать/доработать репозиторий и сервис (final, только для чтения)
-   [ ] Описать интерфейсы и базовые классы при необходимости
-   [ ] Проверить покрытие тестами

---

### 7. Интеграция в контроллер

-   [ ] Внедрить сервис и репозиторий в контроллер через методы или сервис-контейнер
-   [ ] Проверить работоспособность через тесты и ручное тестирование

---

### 8. Документация (Scribe)

-   [ ] Описать новую фичу в документации API
-   [ ] Добавляем в сущестующий подходящий раздел или создаем новый
-   [ ] Сгенерировать новую документацию через knuckleswtf/scribe
-   [ ] Проверить, что все эндпоинты и параметры описаны

**Пример команды:**

```bash
docker-compose -f docker-compose.local.yml exec php php artisan scribe:generate
```

---

### 9. Тесты

-   [ ] Добавить feature-тесты для новой фичи
-   [ ] Проверить покрытие тестами
-   [ ] Все тесты должны проходить

**Пример команды:**

```bash
docker-compose -f docker-compose.local.yml exec php php artisan test
```

### 10. Фича документация

-   [ ] Добавить файл с соответствующим названием
-   [ ] Описать документацию в соотвествии с уже создаными примерами

---

## Автоматизация и CI/CD

-   Рекомендуется использовать Makefile или bash-скрипты для типовых команд (например, make migrate-fresh-seed, make test)
-   Все тесты и линтинг должны проходить в CI/CD перед мержем изменений

---

## Шаблон для описания новой фичи

**Название фичи:**
**Цель:**
**Сущности и поля:**
**Права доступа:**
**Сценарии использования:**
**Требуемые тесты:**
**Документация:**

---

## FAQ и типовые ошибки

-   Ошибка миграции: проверьте порядок миграций и зависимости
-   Проблемы с сидерами: убедитесь, что сиды используют актуальные модели и фабрики
-   Ошибки прав в Filament: проверьте policies и middleware
-   Не отображается новая сущность в админке: проверьте регистрацию ресурса в Filament

---

## Пример полного цикла (на примере сущности Tag)

1. Создать миграцию, сид, фабрику для Tag
2. Описать модель Tag
3. Добавить TagResource в Filament
4. Создать роуты и TagController
5. Описать TagStoreRequest
6. Реализовать TagRepository и TagService
7. Внедрить сервис и репозиторий в TagController
8. Описать эндпоинты в Scribe
9. Добавить feature-тесты для Tag
10. Заполняем фича документацию по уже готовым примерам в docs/features

---

## Обратная связь и доработки

-   Все предложения по улучшению workflow.md добавляйте в этот раздел или обсуждайте в команде

---

## Примечания

-   На каждом этапе использовать best practices Laravel и PHP
-   Все изменения согласовывать с архитектурой проекта
-   После каждого этапа проводить ревью и тестирование
